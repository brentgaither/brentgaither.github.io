
<head>

  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Sql Filestream</title>
  <meta name="description" content="How do I store files?!You have four main options, you can use a file share (map db rows to a file on a fileshare), a filetable (sql 2012 - store files in a p...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>

  <link rel="canonical" href="http://localhost:4000/2018/07/24/Filestream.html">
  <link rel="alternate" type="application/rss+xml" title="Brent Gaither" href="http://localhost:4000/feed.xml">
</head>

<nav class="nav nav-pills flex-column flex-sm-row">
  <a class="flex-sm-fill text-sm-center nav-link" href="/">Brent Gaither</a>
  <a class="flex-sm-fill text-sm-center nav-link" href="/about">About</a>
  <a class="flex-sm-fill text-sm-center nav-link" href="/PokemonGo">PokemonGo</a>
</nav>

<body>
<div class="row">
  <div class="col"></div>
  <div class="col-8">
    <header class="post-header">
  
  <span class="badge badge-success">filestream</span>
  
  <span class="badge badge-success">sql</span>
  
  <h1 class="post-title" itemprop="name headline">Sql Filestream</h1>
  <p class="post-meta">
    <time datetime="2018-07-24T00:00:00-06:00" itemprop="datePublished">Jul 24, 2018
    </time>
    
  </p>
  <meta charset='utf-8'>
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  <link href='https://fonts.googleapis.com/css?family=Chivo:900' rel='stylesheet' type='text/css'>
  <title>Brentgaither.GitHub.io by brentgaither</title>
</header>

<div class="post-content" itemprop="articleBody">
  <h1 id="how-do-i-store-files">How do I store files?!</h1>
<p>You have four main options, you can use a file share (map db rows to a file on a fileshare), a filetable (sql 2012 - store files in a predefined table from sql), a filestream (sql 2008 - varbinary column backed by ntfs), or a store them in the database as a blob or base64 string. Each of the different file storage implementations has its own advantages and disadvantages, I decided to use a filestream because of the file sizes I am dealing with, speed, file integrity and a requirement to send the files over a web api. Setting up a file system is a big task and no matter how you setup your file system there will be considerations.</p>

<p>I wont get too into the pros and cons of all of the ways to store files, but the main points I want to bring up are file integrity vs ease of use. Blobs and file shares can be easier to implement, but fall short in speed and reliability. Blobs are heavy to store in the database and can add a lot of data and slow down performance. File shares lack integrity which can be a huge problem. A Filestream database can be harder to implement, but guarantees the files you pull from your db are backed by a file. Blobs guarantee that your file is still there, but for files over 1mb filestream greatly out performs blobs.</p>
<h1 id="setup-a-filestream-database">Setup a filestream database</h1>
<p>To setup a filestream db you need to enable filestream on the server and setup the database to use the filestream.</p>
<ul>
  <li>Go to SQL Server Configuration Manager.</li>
  <li>If you donâ€™t have sql configuration manager run sqlservermanager11.msc and add the confiuration manager snap-in right-click SQL Server Services, and open.</li>
  <li>In the SQL Server Configuration Manager snap-in, find  SQL Server instance you are enabling FILESTREAM</li>
  <li>Right-click and go to Properties.</li>
  <li>Click the FILESTREAM tab.</li>
  <li>Check the Enable FILESTREAM for Transact-SQL access check box.</li>
  <li>If you want to read and write FILESTREAM data from Windows, click Enable FILESTREAM for file I/O streaming access. Enter the name of the Windows share in the Windows Share Name box.</li>
  <li>If you are setting up a dotnet application to use the filestream you want to check this box.</li>
  <li>If remote clients must access the FILESTREAM data that is stored on this share, select allow remote clients to have streaming access to FILESTREAM data. If you are running your application with separate users for the db and for the app pool or if you are running the application from multiple web servers and db servers you will need to enable remote access.</li>
  <li>Hit Apply.
Now you have file stream enabled lets create a database</li>
</ul>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">DATABASE</span> <span class="n">FileStreamDb</span>
<span class="c1">--You must restart the service once you run this!</span>
<span class="k">EXEC</span> <span class="n">sp_configure</span> <span class="n">filestream_access_level</span><span class="p">,</span> <span class="mi">2</span>
<span class="n">RECONFIGURE</span>
<span class="k">ALTER</span> <span class="k">DATABASE</span> <span class="n">FileStreamDb</span>
<span class="k">ADD</span> <span class="n">FILEGROUP</span> <span class="n">files</span> <span class="k">CONTAINS</span> <span class="n">FILESTREAM</span>
<span class="k">GO</span>
<span class="k">ALTER</span> <span class="k">DATABASE</span> <span class="n">FileStreamDb</span>
  <span class="k">ADD</span> <span class="n">FILE</span> <span class="p">(</span> <span class="n">NAME</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'MyFiles'</span><span class="p">,</span>
  <span class="n">FILENAME</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'C:</span><span class="se">\M</span><span class="s1">yFiles'</span> <span class="p">)</span>  <span class="c1">-- where you want to store your files</span>
<span class="k">TO</span> <span class="n">FILEGROUP</span> <span class="n">files</span>
<span class="k">GO</span>
<span class="n">USE</span> <span class="p">[</span><span class="n">FileStreamDb</span><span class="p">]</span>
<span class="k">GO</span>
<span class="k">SET</span> <span class="n">ANSI_NULLS</span> <span class="k">ON</span>
<span class="k">GO</span>
<span class="k">SET</span> <span class="n">QUOTED_IDENTIFIER</span> <span class="k">ON</span>
<span class="k">GO</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">SystemFile</span><span class="p">](</span>
  <span class="p">[</span><span class="n">Id</span><span class="p">]</span> <span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="p">[</span><span class="n">FileId</span><span class="p">]</span> <span class="p">[</span><span class="n">uniqueidentifier</span><span class="p">]</span> <span class="n">ROWGUIDCOL</span>  <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="p">[</span><span class="n">FileData</span><span class="p">]</span> <span class="p">[</span><span class="n">varbinary</span><span class="p">](</span><span class="k">max</span><span class="p">)</span> <span class="n">FILESTREAM</span>  <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="p">[</span><span class="n">MimeType</span><span class="p">]</span> <span class="p">[</span><span class="n">varchar</span><span class="p">](</span><span class="mi">50</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="p">[</span><span class="n">FileName</span><span class="p">]</span> <span class="p">[</span><span class="n">varchar</span><span class="p">](</span><span class="mi">256</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="p">[</span><span class="n">Uploaded</span><span class="p">]</span> <span class="p">[</span><span class="n">datetime</span><span class="p">]</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="n">CLUSTERED</span>
  <span class="p">(</span>
    <span class="p">[</span><span class="n">Id</span><span class="p">]</span> <span class="k">ASC</span>
    <span class="p">)</span><span class="k">WITH</span> <span class="p">(</span><span class="n">PAD_INDEX</span> <span class="o">=</span> <span class="k">OFF</span><span class="p">,</span> <span class="n">STATISTICS_NORECOMPUTE</span> <span class="o">=</span> <span class="k">OFF</span><span class="p">,</span>
      <span class="n">IGNORE_DUP_KEY</span> <span class="o">=</span> <span class="k">OFF</span><span class="p">,</span> <span class="n">ALLOW_ROW_LOCKS</span> <span class="o">=</span> <span class="k">ON</span><span class="p">,</span> <span class="n">ALLOW_PAGE_LOCKS</span> <span class="o">=</span> <span class="k">ON</span><span class="p">)</span> <span class="k">ON</span> <span class="p">[</span><span class="k">PRIMARY</span><span class="p">]</span>
      <span class="n">FILESTREAM_ON</span> <span class="p">[</span><span class="n">files</span><span class="p">],</span>
  <span class="k">UNIQUE</span> <span class="n">NONCLUSTERED</span>
  <span class="p">(</span>
    <span class="p">[</span><span class="n">FileId</span><span class="p">]</span> <span class="k">ASC</span>
    <span class="p">)</span><span class="k">WITH</span> <span class="p">(</span><span class="n">PAD_INDEX</span> <span class="o">=</span> <span class="k">OFF</span><span class="p">,</span> <span class="n">STATISTICS_NORECOMPUTE</span> <span class="o">=</span> <span class="k">OFF</span><span class="p">,</span>
      <span class="n">IGNORE_DUP_KEY</span> <span class="o">=</span> <span class="k">OFF</span><span class="p">,</span> <span class="n">ALLOW_ROW_LOCKS</span> <span class="o">=</span> <span class="k">ON</span><span class="p">,</span>
      <span class="n">ALLOW_PAGE_LOCKS</span> <span class="o">=</span> <span class="k">ON</span><span class="p">)</span> <span class="k">ON</span> <span class="p">[</span><span class="k">PRIMARY</span><span class="p">]</span>
    <span class="p">)</span> <span class="k">ON</span> <span class="p">[</span><span class="k">PRIMARY</span><span class="p">]</span> <span class="n">FILESTREAM_ON</span> <span class="p">[</span><span class="n">files</span><span class="p">]</span>
  <span class="k">GO</span>
  <span class="k">ALTER</span> <span class="k">TABLE</span> <span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">SystemFile</span><span class="p">]</span> <span class="k">ADD</span>  <span class="k">DEFAULT</span> <span class="p">(</span><span class="n">newsequentialid</span><span class="p">())</span> <span class="k">FOR</span> <span class="p">[</span><span class="n">FileId</span><span class="p">]</span>
  <span class="k">GO</span>
</code></pre></div></div>

<p>Now that you have your database all setup you need to get access to your db files through code. I am not going to go through all of the code since this article does a great job already.
<a href="https://blog.tallan.com/2011/08/22/using-sqlfilestream-with-c-to-access-sql-server-filestream-data/" target="_blank">
https://blog.tallan.com/2011/08/22/using-sqlfilestream-with-c-to-access-sql-server-filestream-data/</a></p>

<p>The main points you need to know are filestreams must use a transaction to stream the data and there is some manual configuration to get the sql filestream to work with the C# streaming.</p>

<p>If you have files that you want to convert from a fileshare to use a filestream you can use the follow script:</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">begin</span> <span class="n">tran</span>
  <span class="k">CREATE</span> <span class="k">TABLE</span> <span class="o">#</span><span class="n">tmpFolders</span><span class="p">(</span><span class="n">myFolderName</span> <span class="n">VARCHAR</span><span class="p">(</span><span class="k">max</span><span class="p">));</span>
   <span class="c1">-- Where are your files that you want to convert?</span>
  <span class="k">INSERT</span> <span class="k">INTO</span> <span class="o">#</span><span class="n">tmpFolders</span> <span class="k">EXEC</span> <span class="n">xp_cmdshell</span> <span class="s1">'dir /B C:</span><span class="se">\C</span><span class="s1">urrentFiles'</span><span class="p">;</span>
  <span class="k">CREATE</span> <span class="k">TABLE</span> <span class="o">#</span><span class="n">tmpFiles</span> <span class="p">(</span><span class="n">myFileName</span> <span class="n">VARCHAR</span><span class="p">(</span><span class="k">max</span><span class="p">));</span>

  <span class="k">declare</span> <span class="o">@</span><span class="n">folderName</span> <span class="n">varchar</span><span class="p">(</span><span class="k">max</span><span class="p">)</span>
  <span class="k">declare</span> <span class="o">@</span><span class="n">fileName</span> <span class="n">varchar</span><span class="p">(</span><span class="k">max</span><span class="p">)</span>
  <span class="k">Declare</span> <span class="o">@</span><span class="k">sql</span> <span class="k">as</span> <span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">)</span>

  <span class="c1">-- Iterate through each folder in the directory</span>
  <span class="n">While</span> <span class="p">(</span><span class="k">Select</span> <span class="k">Count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">From</span> <span class="o">#</span><span class="n">tmpFolders</span> <span class="k">where</span> <span class="n">myFolderName</span> <span class="k">is</span> <span class="k">not</span> <span class="k">null</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="k">Begin</span>
    <span class="k">Select</span> <span class="n">Top</span> <span class="mi">1</span> <span class="o">@</span><span class="n">folderName</span> <span class="o">=</span> <span class="n">myFolderName</span> <span class="k">From</span> <span class="o">#</span><span class="n">tmpFolders</span>
    <span class="k">declare</span> <span class="o">@</span><span class="n">files</span> <span class="k">table</span> <span class="p">(</span><span class="n">ID</span> <span class="n">int</span> <span class="k">IDENTITY</span><span class="p">,</span> <span class="n">FileName</span> <span class="n">varchar</span><span class="p">(</span><span class="k">max</span><span class="p">))</span>
    <span class="c1">-- Where are your files that you want to convert?</span>
    <span class="k">declare</span> <span class="o">@</span><span class="n">currentFolder</span> <span class="n">varchar</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span> <span class="o">=</span> <span class="s1">'C:</span><span class="se">\C</span><span class="s1">urrentFiles'</span>
    <span class="k">declare</span> <span class="o">@</span><span class="n">fileId</span> <span class="n">int</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1">-- Go through all of the files in each folder</span>
    <span class="k">declare</span> <span class="o">@</span><span class="n">fileCommand</span> <span class="n">varchar</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span> <span class="o">=</span> <span class="s1">'dir /B '</span> <span class="o">+</span> <span class="o">@</span><span class="n">currentFolder</span> <span class="o">+</span> <span class="o">@</span><span class="n">folderName</span>
    <span class="k">INSERT</span> <span class="k">INTO</span> <span class="o">#</span><span class="n">tmpFiles</span> <span class="k">execute</span> <span class="n">xp_cmdshell</span> <span class="o">@</span><span class="n">fileCommand</span>
    <span class="n">While</span> <span class="p">(</span><span class="k">Select</span> <span class="k">Count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">From</span> <span class="o">#</span><span class="n">tmpFiles</span> <span class="k">where</span> <span class="n">myFileName</span> <span class="k">is</span> <span class="k">not</span> <span class="k">null</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
      <span class="k">Begin</span>
      <span class="k">Select</span> <span class="n">Top</span> <span class="mi">1</span> <span class="o">@</span><span class="n">fileName</span> <span class="o">=</span> <span class="n">myFileName</span> <span class="k">From</span> <span class="o">#</span><span class="n">tmpFiles</span>
      <span class="c1">-- Load the image data and insert into the table</span>
      <span class="c1">-- (has to be dynamic you cant use variables in a open row set)</span>
      <span class="k">Set</span> <span class="o">@</span><span class="k">sql</span> <span class="o">=</span> <span class="s1">'Insert into FileStreamDb.dbo.systemfile
      (fileName, mimeType, uploaded, filedata)
      Select </span><span class="se">''</span><span class="s1">'</span><span class="o">+</span> <span class="o">@</span><span class="n">fileName</span> <span class="o">+</span> <span class="s1">'</span><span class="se">''</span><span class="s1">,
      </span><span class="se">''</span><span class="s1">application/pdf</span><span class="se">''</span><span class="s1">,
      </span><span class="se">''</span><span class="s1">'</span> <span class="o">+</span> <span class="k">cast</span><span class="p">(</span><span class="n">getdate</span><span class="p">()</span> <span class="k">as</span> <span class="n">varchar</span><span class="p">(</span><span class="mi">256</span><span class="p">))</span> <span class="o">+</span> <span class="s1">'</span><span class="se">''</span><span class="s1">,
      BulkColumn from Openrowset(Bulk</span><span class="se">''</span><span class="s1">'</span> <span class="o">+</span>
      <span class="o">@</span><span class="n">currentFolder</span> <span class="o">+</span> <span class="o">@</span><span class="n">folderName</span> <span class="o">+</span> <span class="s1">'</span><span class="se">\'</span><span class="s1"> + @fileName + </span><span class="se">''</span><span class="s1">'</span><span class="p">,</span> <span class="n">Single_Blob</span><span class="p">)</span> <span class="k">as</span> <span class="n">tt</span><span class="p">;</span>
      <span class="k">SELECT</span> <span class="o">@</span><span class="n">fileId</span> <span class="o">=</span> <span class="n">SCOPE_IDENTITY</span><span class="p">()</span>
      <span class="n">print</span> <span class="o">@</span><span class="k">sql</span>
      <span class="k">EXECUTE</span> <span class="n">sp_executesql</span> <span class="o">@</span><span class="k">sql</span><span class="p">,</span> <span class="n">N</span><span class="s1">'@fileId INTEGER OUTPUT'</span><span class="p">,</span> <span class="o">@</span><span class="n">fileId</span> <span class="k">OUTPUT</span>
      <span class="c1">-- here is the file id you just created you can use this for</span>
      <span class="c1">-- other meta data around the file if you need it</span>
      <span class="n">print</span> <span class="o">@</span><span class="n">fileId</span>
      <span class="k">Delete</span> <span class="k">from</span> <span class="o">#</span><span class="n">tmpFiles</span> <span class="k">Where</span> <span class="n">myFileName</span> <span class="o">=</span> <span class="o">@</span><span class="n">fileName</span>
    <span class="k">End</span>
    <span class="k">truncate</span> <span class="k">table</span> <span class="o">#</span><span class="n">tmpFiles</span>
    <span class="c1">-- OPENROWSET processing goes here, using @folderName to identify which file to use</span>
    <span class="k">Delete</span> <span class="k">from</span> <span class="o">#</span><span class="n">tmpFolders</span> <span class="k">Where</span> <span class="n">myFolderName</span> <span class="o">=</span> <span class="o">@</span><span class="n">folderName</span>

  <span class="k">End</span>

  <span class="k">DROP</span> <span class="k">TABLE</span> <span class="o">#</span><span class="n">tmpFolders</span>
  <span class="k">DROP</span> <span class="k">TABLE</span> <span class="o">#</span><span class="n">tmpFiles</span>


<span class="k">rollback</span>
</code></pre></div></div>

</div>

  </div>
  <div class="col"></div>
</div>
<footer>
  <p><img src="/images/octocat-icon.png"><a href="https://pages.github.com">GitHub Pages</a> Brent Gaither  brent[dot]w[dot]gaither[at]gmail[dot]com</p>

</footer>

</body>
