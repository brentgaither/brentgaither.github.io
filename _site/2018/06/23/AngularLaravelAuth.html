<!DOCTYPE html>
<html>
  
<head>

  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Angular and Laravel Authentication</title>
  <meta name="description" content="I have been working on an Angular 6 application and i was struggling to getall of the authentication setup. I read lots of articles on how to create the enti...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>

  <link rel="canonical" href="http://localhost:4000/2018/06/23/AngularLaravelAuth.html">
  <link rel="alternate" type="application/rss+xml" title="Brent Gaither" href="http://localhost:4000/feed.xml">
</head>

  <nav class="navbar navbar-default">
  <div class="container-fluid">
    <ul class="nav nav-tabs navbar-left">
        <li><a href="/">Brent Gaither</a></li>
        <li><a href="/about">About</a></li>
        <li><a href="/PokemonGo">PokemonGo</a></li>
    </ul>
  </div>
</nav>

  <body>
  <div class="post-content">
    <div class="col-lg-12">
      <div class="col-lg-7 col-lg-offset-2">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header col-md-offset-1 col-lg-offset-1">
    <h1 class="post-title" itemprop="name headline">Angular and Laravel Authentication</h1>
    <p class="post-meta"><time datetime="2018-06-23T00:00:00-06:00" itemprop="datePublished">Jun 23, 2018</time></p>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <link href='https://fonts.googleapis.com/css?family=Chivo:900' rel='stylesheet' type='text/css'>
    <title>Brentgaither.GitHub.io by brentgaither</title>
  </header>

  <div class="post-content" itemprop="articleBody">
    <div class="col-lg-12">
      <div class="col-lg-7 col-lg-offset-2">
          <p>I have been working on an Angular 6 application and i was struggling to get
all of the authentication setup. I read lots of articles on how to create the entire
OAuth workflow and I landed with the following solution for implicit grants.
First you will need to create a Laravel application, I won’t go too much into
how to create a new application, but basically you need to run create the application ‘laravel new authentication’
add authentication ‘php artisan make:auth’ and finally you can add passport (https://laravel.com/docs/master/passport)
#Install Laravel
Basic installation for passport includes running:</p>

<ul>
  <li><code class="highlighter-rouge">composer require laravel/passport</code></li>
  <li><code class="highlighter-rouge">php artisan migrate</code></li>
  <li><code class="highlighter-rouge">php artisan passport:install</code></li>
  <li>add Laravel\Passport\HasApiTokens to your user class</li>
  <li>add Passport::routes to AuthServiceProvider</li>
  <li>add passport to your auth config</li>
  <li>install the pre-built passport components with <code class="highlighter-rouge">php artisan vendor:publish --tag=passport-components</code>.</li>
</ul>

<p>Make sure you are loading your app js after everything else has loaded so vue
can be fully loaded before you try to load its components (put the script tag for app js
  at the bottom of your layout page)</p>

<h1 id="install-angular">Install Angular</h1>
<p>For angular you will need to run a few commands to create the application. I put both the Angular
and Laravel app in the same repository since i wanted to keep it all together,
but it depends on how large the project is if you want to keep them together or not.</p>
<ul>
  <li><code class="highlighter-rouge">npm install -g @angular/cli</code></li>
  <li><code class="highlighter-rouge">ng new my-auth</code></li>
  <li><code class="highlighter-rouge">cd my-auth</code></li>
  <li><code class="highlighter-rouge">ng serve</code></li>
</ul>

<h1 id="configure-the-oauth-server">Configure the OAuth server</h1>

<p>Now you have a simple Angular application and a basic OAuth server setup with passport.
Now we can actually add some code to add authentication to the Angular app. To do this you will need to
first add a client to passport, you can navigate to the page on the Laravel site you made where you put
the passport components click create new client and add your app name as well as ‘http://localhost:4200/callback’ for the redirect url. If you are going to use a different port for your Angular application or if you are going to server this as a real site you will need to change the redirect to “yoursite/callback”.</p>

<h1 id="auth-service">Auth Service</h1>

<p>Once you have the client created we can add a service to detect if the user is logged in.
Create a new service named auth that looks like this</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import { Injectable, Inject } from '@angular/core';
import { BehaviorSubject } from 'rxjs';
import { AUTH_CONFIG } from './auth-config';
import { Router } from '@angular/router';
import { HttpClient } from '@angular/common/http';
import { AuthResult } from './authResult.model';

@Injectable()
export class AuthService {

token: any;

// Create a stream of logged in status to communicate throughout app
loggedIn: boolean;
loggedIn$ = new BehaviorSubject&lt;boolean&gt;(this.loggedIn);

constructor(private router: Router, private http: HttpClient) {  }

getToken (): string {
  return localStorage.getItem('access_token');
}

public tryLogin() {
if (!this.isAuthenticated()) {
 // Send the user to the authenticaition server
  location.href = encodeURI(AUTH_CONFIG.AUTHENTICATION_SERVER + '?'
  + 'client_id=' + AUTH_CONFIG.CLIENT_ID
  + '&amp;redirect_uri=' + AUTH_CONFIG.REDIRECT + '&amp;response_type='
  + AUTH_CONFIG.RESPONSE_TYPE);
  }
}


public setSession(urlFragment): void {
  const authResult = this.parseQueryString(urlFragment);
  // Set the time that the Access Token will expire at
  const expiresAt = JSON.stringify((authResult.expires_in * 1000)
  + new Date().getTime());
  localStorage.setItem('access_token', authResult.access_token);
  localStorage.setItem('token_type', authResult.token_type);
  localStorage.setItem('expires_at', expiresAt);
}

public logout(): void {
  // Remove tokens and expiry time from localStorage
  localStorage.removeItem('access_token');
  localStorage.removeItem('id_token');
  localStorage.removeItem('expires_at');
  // Go back to the home route
  this.router.navigate(['/']);
}

public isAuthenticated(): boolean {
  // Check whether the current time is past the
  // Access Token's expiry time
  const expiresAt = JSON.parse(localStorage.getItem('expires_at'));
  return new Date().getTime() &lt; expiresAt;
}

private parseQueryString ( queryString ): AuthResult {
  const params = {};
  let queries, temp, i, l;
  // Split into key/value pairs
  queries = queryString.split('&amp;');
  // Convert the array of strings into an object
  for ( i = 0, l = queries.length; i &lt; l; i++ ) {
    temp = queries[i].split('=');
    params[temp[0]] = temp[1];
  }
  const authResult = new AuthResult();
  authResult.access_token =  params['access_token'];
  authResult.expires_in =  params['expires_in'];
  authResult.token_type =  params['token_type'];
  return authResult;
}
}

</code></pre></div></div>
<p>This service will take care of the sending the user to the OAuth server
checking their token and parsing the token from the server. We need a few more
files to save all of the configurations for the authorization server.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>export class AuthResult {
  access_token: string;
  expires_in: number;
  token_type: string;
}
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>interface AuthConfig {
  CLIENT_ID: string;
  REDIRECT: string;
  SCOPE: string;
  RESPONSE_TYPE: string;
  AUTHENTICATION_SERVER: string;
}

export const AUTH_CONFIG: AuthConfig = {
  CLIENT_ID: '1',
  REDIRECT: 'http://localhost:4200/callback',
  SCOPE: '',
  RESPONSE_TYPE: 'token',
  AUTHENTICATION_SERVER: 'http://127.0.0.1:8000/oauth/authorize'
};
</code></pre></div></div>

<h1 id="callback-component">Callback component</h1>
<p>Now that we have a service to handle authentication we need to handle the callback
from the auth server. To do this create a new component (ng g c callback). It is a very simple component that will just
send some data to the auth service and maybe run a spinner while it waits.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import { Component, OnInit } from '@angular/core';
import { AuthService } from '../auth/auth.service';
import { ActivatedRoute } from '@angular/router';

@Component({
  selector: 'app-callback',
  templateUrl: './callback.component.html',
  styleUrls: ['./callback.component.css']
})
export class CallbackComponent implements OnInit {

  constructor(private authService: AuthService, private route: ActivatedRoute) { }

  accessToken: string;
  ngOnInit() {
    this.route.fragment.subscribe((fragment: string) =&gt; {
      this.authService.setSession(fragment);
    });
    location.href = '/';
  }
}
</code></pre></div></div>

<h1 id="home-component">Home component</h1>
<p>Lets create a simple component to check and see if the user is logged in (ng g c home)</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import { Component, OnInit } from '@angular/core';
import { AuthService } from '../auth/auth.service';

@Component({
  selector: 'app-home',
  templateUrl: './home.component.html',
  styleUrls: ['./home.component.css']
})
export class HomeComponent {

  constructor(private authService: AuthService) {}

  public logout(): void {
    this.authService.logout();
  }
  public login(): void {
    this.authService.tryLogin();
  }

  public authenticated(): boolean {
    return this.authService.isAuthenticated();
  }
}
</code></pre></div></div>

<p>Now add some html in the home component</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      &lt;button
      *ngIf="this.authenticated()"
      mat-menu-item
      aria-label="Logout"
      (click)="logout()"&gt;
      Log out
    &lt;/button&gt;
    &lt;button
      *ngIf="!this.authenticated()"
      mat-menu-item
      aria-label="Login"
      (click)="login()"&gt;
      Sign in
    &lt;/button&gt;
</code></pre></div></div>

<h1 id="routing">Routing</h1>
<p>We will also need to add RouterModule to the app module so the app can use Angular’s routing. Create a simple routing module and import it into your app module.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import { NgModule } from '@angular/core';
import { RouterModule, Routes } from '@angular/router';

import { HomeComponent } from './home/home.component';
import { CallbackComponent } from './callback/callback.component';


const routes: Routes = [
  { path: '', redirectTo: '/home', pathMatch: 'full' },
  { path: 'home', component: HomeComponent, },
  { path: 'callback', component: CallbackComponent, },
];

@NgModule({
  imports: [ RouterModule.forRoot(routes) ],
  exports: [ RouterModule ],
  providers: []
})
export class AppRoutingModule {}
</code></pre></div></div>

<h1 id="http-interceptor">Http interceptor</h1>
<p>Click the sign in button and it should all work! Oh no… “unsupported_grant_type”, looks like something is setup
wrong for the authorization server. If we go to Laravel’s documentation we can see that for implicit flow to work we need to add  Passport::enableImplicitGrant(); to AuthServiceProvider (right after where we registered the passport routes) Now everything should work and we will have an authorization token in local storage. Theres just one more thing. When we send requests to the server from a component we will have to go to the authorization service and add the token in the header. Instead of doing that on each request we can add an http interceptor to our project and let that take care of sending the token on each request.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import {throwError as observableThrowError,  Observable } from 'rxjs';

import {catchError} from 'rxjs/operators';
import { Injectable, Injector } from '@angular/core';
import { HttpEvent, HttpInterceptor, HttpHandler, HttpRequest } from '@angular/common/http';
import { AuthService } from './auth/auth.service';

@Injectable()
export class MyHttpInterceptor implements HttpInterceptor {
constructor(private authService: AuthService) { }

intercept(req: HttpRequest&lt;any&gt;, next: HttpHandler): Observable&lt;HttpEvent&lt;any&gt;&gt; {

  // Clone the request to add the new header.
  const authReq = req.clone({ headers: req.headers.set('Authorization', 'Bearer ' + this.authService.getToken())});

  // send the newly created request
  return next.handle(authReq).pipe(
      catchError((error, caught) =&gt; {
      // intercept the response error and displace it to the console
      console.log('Error Occurred');
      console.log(error);
      // return the error to the method that called it
      return observableThrowError(error);
  })) as any;
  }
}
</code></pre></div></div>
<p>Once you add the class MyHttpInterceptor you need to add it to your providers in app module and it will send the header Authorization with Bearer and an access token on each request!</p>

<p><code class="highlighter-rouge">
providers: [AuthService,
{
provide: HTTP_INTERCEPTORS,
useClass: MyHttpInterceptor,
multi: true
}],
</code></p>

      </div>
    </div>
  </div>
</article>

      </div>
    </div>
  </div>
    <footer>
  <p><img src="/images/octocat-icon.png"><a href="https://pages.github.com">GitHub Pages</a> Brent Gaither  brent[dot]w[dot]gaither[at]gmail[dot]com</p>

</footer>

  </body>
</html>
