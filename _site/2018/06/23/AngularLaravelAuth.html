
<head>

  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Angular and Laravel Authentication</title>
  <meta name="description" content="I have been working on an Angular 6 application and i was struggling to getall of the authentication setup. I read lots of articles on how to create the enti...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>

  <link rel="canonical" href="http://localhost:4000/2018/06/23/AngularLaravelAuth.html">
  <link rel="alternate" type="application/rss+xml" title="Brent Gaither" href="http://localhost:4000/feed.xml">
</head>

<nav class="nav nav-pills flex-column flex-sm-row">
  <a class="flex-sm-fill text-sm-center nav-link" href="/">Brent Gaither</a>
  <a class="flex-sm-fill text-sm-center nav-link" href="/about">About</a>
  <a class="flex-sm-fill text-sm-center nav-link" href="/PokemonGo">PokemonGo</a>
</nav>

<body>
<div class="row">
  <div class="col"></div>
  <div class="col-8">
    <header class="post-header">
  
  <span class="badge badge-success">authentication</span>
  
  <span class="badge badge-success">laravel</span>
  
  <h1 class="post-title" itemprop="name headline">Angular and Laravel Authentication</h1>
  <p class="post-meta">
    <time datetime="2018-06-23T00:00:00-06:00" itemprop="datePublished">Jun 23, 2018
    </time>
    
  </p>
  <meta charset='utf-8'>
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  <link href='https://fonts.googleapis.com/css?family=Chivo:900' rel='stylesheet' type='text/css'>
  <title>Brentgaither.GitHub.io by brentgaither</title>
</header>

<div class="post-content" itemprop="articleBody">
  <p>I have been working on an Angular 6 application and i was struggling to get
all of the authentication setup. I read lots of articles on how to create the entire
OAuth workflow and I landed with the following solution for implicit grants.
First you will need to create a Laravel application, I won’t go too much into
how to create a new application, but basically you need to run create the application ‘laravel new authentication’
add authentication ‘php artisan make:auth’ and finally you can add passport (https://laravel.com/docs/master/passport)
#Install Laravel
Basic installation for passport includes running:</p>

<ul>
  <li><code class="highlighter-rouge">composer require laravel/passport</code></li>
  <li><code class="highlighter-rouge">php artisan migrate</code></li>
  <li><code class="highlighter-rouge">php artisan passport:install</code></li>
  <li>add Laravel\Passport\HasApiTokens to your user class</li>
  <li>add Passport::routes to AuthServiceProvider</li>
  <li>add passport to your auth config</li>
  <li>install the pre-built passport components with <code class="highlighter-rouge">php artisan vendor:publish --tag=passport-components</code>.</li>
</ul>

<p>Make sure you are loading your app js after everything else has loaded so vue
can be fully loaded before you try to load its components (put the script tag for app js
  at the bottom of your layout page)</p>

<h1 id="install-angular">Install Angular</h1>
<p>For angular you will need to run a few commands to create the application. I put both the Angular
and Laravel app in the same repository since i wanted to keep it all together,
but it depends on how large the project is if you want to keep them together or not.</p>
<ul>
  <li><code class="highlighter-rouge">npm install -g @angular/cli</code></li>
  <li><code class="highlighter-rouge">ng new my-auth</code></li>
  <li><code class="highlighter-rouge">cd my-auth</code></li>
  <li><code class="highlighter-rouge">ng serve</code></li>
</ul>

<h1 id="configure-the-oauth-server">Configure the OAuth server</h1>

<p>Now you have a simple Angular application and a basic OAuth server setup with passport.
Now we can actually add some code to add authentication to the Angular app. To do this you will need to
first add a client to passport, you can navigate to the page on the Laravel site you made where you put
the passport components click create new client and add your app name as well as ‘http://localhost:4200/callback’ for the redirect url. If you are going to use a different port for your Angular application or if you are going to server this as a real site you will need to change the redirect to “yoursite/callback”.</p>

<h1 id="auth-service">Auth Service</h1>

<p>Once you have the client created we can add a service to detect if the user is logged in.
Create a new service named auth that looks like this</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Injectable</span><span class="p">,</span> <span class="nx">Inject</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/core'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">BehaviorSubject</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'rxjs'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">AUTH_CONFIG</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'./auth-config'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">Router</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/router'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">HttpClient</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/common/http'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">AuthResult</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'./authResult.model'</span><span class="p">;</span>

<span class="p">@</span><span class="nd">Injectable</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">AuthService</span> <span class="p">{</span>

<span class="nl">token</span><span class="p">:</span> <span class="nx">any</span><span class="p">;</span>

<span class="c1">// Create a stream of logged in status to communicate throughout app</span>
<span class="nl">loggedIn</span><span class="p">:</span> <span class="kr">boolean</span><span class="p">;</span>
<span class="nx">loggedIn$</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BehaviorSubject</span><span class="o">&lt;</span><span class="kr">boolean</span><span class="o">&gt;</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">loggedIn</span><span class="p">);</span>

<span class="kd">constructor</span><span class="p">(</span><span class="kr">private</span> <span class="nx">router</span><span class="p">:</span> <span class="nx">Router</span><span class="p">,</span> <span class="kr">private</span> <span class="nx">http</span><span class="p">:</span> <span class="nx">HttpClient</span><span class="p">)</span> <span class="p">{</span>  <span class="p">}</span>

<span class="nx">getToken</span> <span class="p">():</span> <span class="nx">string</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">localStorage</span><span class="p">.</span><span class="nx">getItem</span><span class="p">(</span><span class="s1">'access_token'</span><span class="p">);</span>
<span class="p">}</span>

<span class="kr">public</span> <span class="nx">tryLogin</span><span class="p">()</span> <span class="p">{</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">isAuthenticated</span><span class="p">())</span> <span class="p">{</span>
 <span class="c1">// Send the user to the authenticaition server</span>
  <span class="nx">location</span><span class="p">.</span><span class="nx">href</span> <span class="o">=</span> <span class="nb">encodeURI</span><span class="p">(</span><span class="nx">AUTH_CONFIG</span><span class="p">.</span><span class="nx">AUTHENTICATION_SERVER</span> <span class="o">+</span> <span class="s1">'?'</span>
  <span class="o">+</span> <span class="s1">'client_id='</span> <span class="o">+</span> <span class="nx">AUTH_CONFIG</span><span class="p">.</span><span class="nx">CLIENT_ID</span>
  <span class="o">+</span> <span class="s1">'&amp;redirect_uri='</span> <span class="o">+</span> <span class="nx">AUTH_CONFIG</span><span class="p">.</span><span class="nx">REDIRECT</span> <span class="o">+</span> <span class="s1">'&amp;response_type='</span>
  <span class="o">+</span> <span class="nx">AUTH_CONFIG</span><span class="p">.</span><span class="nx">RESPONSE_TYPE</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>


<span class="kr">public</span> <span class="nx">setSession</span><span class="p">(</span><span class="nx">urlFragment</span><span class="p">):</span> <span class="k">void</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">authResult</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">parseQueryString</span><span class="p">(</span><span class="nx">urlFragment</span><span class="p">);</span>
  <span class="c1">// Set the time that the Access Token will expire at</span>
  <span class="kd">const</span> <span class="nx">expiresAt</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">((</span><span class="nx">authResult</span><span class="p">.</span><span class="nx">expires_in</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
  <span class="o">+</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">());</span>
  <span class="nx">localStorage</span><span class="p">.</span><span class="nx">setItem</span><span class="p">(</span><span class="s1">'access_token'</span><span class="p">,</span> <span class="nx">authResult</span><span class="p">.</span><span class="nx">access_token</span><span class="p">);</span>
  <span class="nx">localStorage</span><span class="p">.</span><span class="nx">setItem</span><span class="p">(</span><span class="s1">'token_type'</span><span class="p">,</span> <span class="nx">authResult</span><span class="p">.</span><span class="nx">token_type</span><span class="p">);</span>
  <span class="nx">localStorage</span><span class="p">.</span><span class="nx">setItem</span><span class="p">(</span><span class="s1">'expires_at'</span><span class="p">,</span> <span class="nx">expiresAt</span><span class="p">);</span>
<span class="p">}</span>

<span class="kr">public</span> <span class="nx">logout</span><span class="p">():</span> <span class="k">void</span> <span class="p">{</span>
  <span class="c1">// Remove tokens and expiry time from localStorage</span>
  <span class="nx">localStorage</span><span class="p">.</span><span class="nx">removeItem</span><span class="p">(</span><span class="s1">'access_token'</span><span class="p">);</span>
  <span class="nx">localStorage</span><span class="p">.</span><span class="nx">removeItem</span><span class="p">(</span><span class="s1">'id_token'</span><span class="p">);</span>
  <span class="nx">localStorage</span><span class="p">.</span><span class="nx">removeItem</span><span class="p">(</span><span class="s1">'expires_at'</span><span class="p">);</span>
  <span class="c1">// Go back to the home route</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">router</span><span class="p">.</span><span class="nx">navigate</span><span class="p">([</span><span class="s1">'/'</span><span class="p">]);</span>
<span class="p">}</span>

<span class="kr">public</span> <span class="nx">isAuthenticated</span><span class="p">():</span> <span class="kr">boolean</span> <span class="p">{</span>
  <span class="c1">// Check whether the current time is past the</span>
  <span class="c1">// Access Token's expiry time</span>
  <span class="kd">const</span> <span class="nx">expiresAt</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">localStorage</span><span class="p">.</span><span class="nx">getItem</span><span class="p">(</span><span class="s1">'expires_at'</span><span class="p">));</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">()</span> <span class="o">&lt;</span> <span class="nx">expiresAt</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">private</span> <span class="nx">parseQueryString</span> <span class="p">(</span> <span class="nx">queryString</span> <span class="p">):</span> <span class="nx">AuthResult</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="kd">let</span> <span class="nx">queries</span><span class="p">,</span> <span class="nx">temp</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">l</span><span class="p">;</span>
  <span class="c1">// Split into key/value pairs</span>
  <span class="nx">queries</span> <span class="o">=</span> <span class="nx">queryString</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">'&amp;'</span><span class="p">);</span>
  <span class="c1">// Convert the array of strings into an object</span>
  <span class="k">for</span> <span class="p">(</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">queries</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
    <span class="nx">temp</span> <span class="o">=</span> <span class="nx">queries</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">split</span><span class="p">(</span><span class="s1">'='</span><span class="p">);</span>
    <span class="nx">params</span><span class="p">[</span><span class="nx">temp</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="nx">temp</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
  <span class="p">}</span>
  <span class="kd">const</span> <span class="nx">authResult</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AuthResult</span><span class="p">();</span>
  <span class="nx">authResult</span><span class="p">.</span><span class="nx">access_token</span> <span class="o">=</span>  <span class="nx">params</span><span class="p">[</span><span class="s1">'access_token'</span><span class="p">];</span>
  <span class="nx">authResult</span><span class="p">.</span><span class="nx">expires_in</span> <span class="o">=</span>  <span class="nx">params</span><span class="p">[</span><span class="s1">'expires_in'</span><span class="p">];</span>
  <span class="nx">authResult</span><span class="p">.</span><span class="nx">token_type</span> <span class="o">=</span>  <span class="nx">params</span><span class="p">[</span><span class="s1">'token_type'</span><span class="p">];</span>
  <span class="k">return</span> <span class="nx">authResult</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>
<p>This service will take care of the sending the user to the OAuth server
checking their token and parsing the token from the server. We need a few more
files to save all of the configurations for the authorization server.</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">export</span> <span class="kd">class</span> <span class="nx">AuthResult</span> <span class="p">{</span>
  <span class="nl">access_token</span><span class="p">:</span> <span class="nx">string</span><span class="p">;</span>
  <span class="nl">expires_in</span><span class="p">:</span> <span class="nx">number</span><span class="p">;</span>
  <span class="nl">token_type</span><span class="p">:</span> <span class="nx">string</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">interface</span> <span class="nx">AuthConfig</span> <span class="p">{</span>
  <span class="nl">CLIENT_ID</span><span class="p">:</span> <span class="nx">string</span><span class="p">;</span>
  <span class="nl">REDIRECT</span><span class="p">:</span> <span class="nx">string</span><span class="p">;</span>
  <span class="nl">SCOPE</span><span class="p">:</span> <span class="nx">string</span><span class="p">;</span>
  <span class="nl">RESPONSE_TYPE</span><span class="p">:</span> <span class="nx">string</span><span class="p">;</span>
  <span class="nl">AUTHENTICATION_SERVER</span><span class="p">:</span> <span class="nx">string</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">export</span> <span class="kd">const</span> <span class="nx">AUTH_CONFIG</span><span class="p">:</span> <span class="nx">AuthConfig</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">CLIENT_ID</span><span class="p">:</span> <span class="s1">'1'</span><span class="p">,</span>
  <span class="na">REDIRECT</span><span class="p">:</span> <span class="s1">'http://localhost:4200/callback'</span><span class="p">,</span>
  <span class="na">SCOPE</span><span class="p">:</span> <span class="s1">''</span><span class="p">,</span>
  <span class="na">RESPONSE_TYPE</span><span class="p">:</span> <span class="s1">'token'</span><span class="p">,</span>
  <span class="na">AUTHENTICATION_SERVER</span><span class="p">:</span> <span class="s1">'http://127.0.0.1:8000/oauth/authorize'</span>
<span class="p">};</span>
</code></pre></div></div>

<h1 id="callback-component">Callback component</h1>
<p>Now that we have a service to handle authentication we need to handle the callback
from the auth server. To do this create a new component (ng g c callback). It is a very simple component that will just
send some data to the auth service and maybe run a spinner while it waits.</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Component</span><span class="p">,</span> <span class="nx">OnInit</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/core'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">AuthService</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'../auth/auth.service'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">ActivatedRoute</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/router'</span><span class="p">;</span>

<span class="p">@</span><span class="nd">Component</span><span class="p">({</span>
  <span class="na">selector</span><span class="p">:</span> <span class="s1">'app-callback'</span><span class="p">,</span>
  <span class="na">templateUrl</span><span class="p">:</span> <span class="s1">'./callback.component.html'</span><span class="p">,</span>
  <span class="na">styleUrls</span><span class="p">:</span> <span class="p">[</span><span class="s1">'./callback.component.css'</span><span class="p">]</span>
<span class="p">})</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">CallbackComponent</span> <span class="kr">implements</span> <span class="nx">OnInit</span> <span class="p">{</span>

  <span class="kd">constructor</span><span class="p">(</span><span class="kr">private</span> <span class="nx">authService</span><span class="p">:</span> <span class="nx">AuthService</span><span class="p">,</span> <span class="kr">private</span> <span class="nx">route</span><span class="p">:</span> <span class="nx">ActivatedRoute</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>

  <span class="nl">accessToken</span><span class="p">:</span> <span class="nx">string</span><span class="p">;</span>
  <span class="nx">ngOnInit</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">route</span><span class="p">.</span><span class="nx">fragment</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">((</span><span class="nx">fragment</span><span class="p">:</span> <span class="nx">string</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">authService</span><span class="p">.</span><span class="nx">setSession</span><span class="p">(</span><span class="nx">fragment</span><span class="p">);</span>
    <span class="p">});</span>
    <span class="nx">location</span><span class="p">.</span><span class="nx">href</span> <span class="o">=</span> <span class="s1">'/'</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h1 id="home-component">Home component</h1>
<p>Lets create a simple component to check and see if the user is logged in (ng g c home)</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Component</span><span class="p">,</span> <span class="nx">OnInit</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/core'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">AuthService</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'../auth/auth.service'</span><span class="p">;</span>

<span class="p">@</span><span class="nd">Component</span><span class="p">({</span>
  <span class="na">selector</span><span class="p">:</span> <span class="s1">'app-home'</span><span class="p">,</span>
  <span class="na">templateUrl</span><span class="p">:</span> <span class="s1">'./home.component.html'</span><span class="p">,</span>
  <span class="na">styleUrls</span><span class="p">:</span> <span class="p">[</span><span class="s1">'./home.component.css'</span><span class="p">]</span>
<span class="p">})</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">HomeComponent</span> <span class="p">{</span>

  <span class="kd">constructor</span><span class="p">(</span><span class="kr">private</span> <span class="nx">authService</span><span class="p">:</span> <span class="nx">AuthService</span><span class="p">)</span> <span class="p">{}</span>

  <span class="kr">public</span> <span class="nx">logout</span><span class="p">():</span> <span class="k">void</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">authService</span><span class="p">.</span><span class="nx">logout</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="kr">public</span> <span class="nx">login</span><span class="p">():</span> <span class="k">void</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">authService</span><span class="p">.</span><span class="nx">tryLogin</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="kr">public</span> <span class="nx">authenticated</span><span class="p">():</span> <span class="kr">boolean</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">authService</span><span class="p">.</span><span class="nx">isAuthenticated</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Now add some html in the home component</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      <span class="nt">&lt;button</span>
      <span class="err">*</span><span class="na">ngIf=</span><span class="s">"this.authenticated()"</span>
      <span class="na">mat-menu-item</span>
      <span class="na">aria-label=</span><span class="s">"Logout"</span>
      <span class="err">(</span><span class="na">click</span><span class="err">)="</span><span class="na">logout</span><span class="err">()"</span><span class="nt">&gt;</span>
      Log out
    <span class="nt">&lt;/button&gt;</span>
    <span class="nt">&lt;button</span>
      <span class="err">*</span><span class="na">ngIf=</span><span class="s">"!this.authenticated()"</span>
      <span class="na">mat-menu-item</span>
      <span class="na">aria-label=</span><span class="s">"Login"</span>
      <span class="err">(</span><span class="na">click</span><span class="err">)="</span><span class="na">login</span><span class="err">()"</span><span class="nt">&gt;</span>
      Sign in
    <span class="nt">&lt;/button&gt;</span>
</code></pre></div></div>

<h1 id="routing">Routing</h1>
<p>We will also need to add RouterModule to the app module so the app can use Angular’s routing. Create a simple routing module and import it into your app module.</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">NgModule</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/core'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">RouterModule</span><span class="p">,</span> <span class="nx">Routes</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/router'</span><span class="p">;</span>

<span class="k">import</span> <span class="p">{</span> <span class="nx">HomeComponent</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'./home/home.component'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">CallbackComponent</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'./callback/callback.component'</span><span class="p">;</span>


<span class="kd">const</span> <span class="nx">routes</span><span class="p">:</span> <span class="nx">Routes</span> <span class="o">=</span> <span class="p">[</span>
  <span class="p">{</span> <span class="na">path</span><span class="p">:</span> <span class="s1">''</span><span class="p">,</span> <span class="na">redirectTo</span><span class="p">:</span> <span class="s1">'/home'</span><span class="p">,</span> <span class="na">pathMatch</span><span class="p">:</span> <span class="s1">'full'</span> <span class="p">},</span>
  <span class="p">{</span> <span class="na">path</span><span class="p">:</span> <span class="s1">'home'</span><span class="p">,</span> <span class="na">component</span><span class="p">:</span> <span class="nx">HomeComponent</span><span class="p">,</span> <span class="p">},</span>
  <span class="p">{</span> <span class="na">path</span><span class="p">:</span> <span class="s1">'callback'</span><span class="p">,</span> <span class="na">component</span><span class="p">:</span> <span class="nx">CallbackComponent</span><span class="p">,</span> <span class="p">},</span>
<span class="p">];</span>

<span class="p">@</span><span class="nd">NgModule</span><span class="p">({</span>
  <span class="na">imports</span><span class="p">:</span> <span class="p">[</span> <span class="nx">RouterModule</span><span class="p">.</span><span class="nx">forRoot</span><span class="p">(</span><span class="nx">routes</span><span class="p">)</span> <span class="p">],</span>
  <span class="na">exports</span><span class="p">:</span> <span class="p">[</span> <span class="nx">RouterModule</span> <span class="p">],</span>
  <span class="na">providers</span><span class="p">:</span> <span class="p">[]</span>
<span class="p">})</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">AppRoutingModule</span> <span class="p">{}</span>
</code></pre></div></div>

<h1 id="http-interceptor">Http interceptor</h1>
<p>Click the sign in button and it should all work! Oh no… “unsupported_grant_type”, looks like something is setup
wrong for the authorization server. If we go to Laravel’s documentation we can see that for implicit flow to work we need to add  Passport::enableImplicitGrant(); to AuthServiceProvider (right after where we registered the passport routes) Now everything should work and we will have an authorization token in local storage. Theres just one more thing. When we send requests to the server from a component we will have to go to the authorization service and add the token in the header. Instead of doing that on each request we can add an http interceptor to our project and let that take care of sending the token on each request.</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span><span class="nx">throwError</span> <span class="k">as</span> <span class="nx">observableThrowError</span><span class="p">,</span>  <span class="nx">Observable</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'rxjs'</span><span class="p">;</span>

<span class="k">import</span> <span class="p">{</span><span class="nx">catchError</span><span class="p">}</span> <span class="k">from</span> <span class="s1">'rxjs/operators'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">Injectable</span><span class="p">,</span> <span class="nx">Injector</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/core'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">HttpEvent</span><span class="p">,</span> <span class="nx">HttpInterceptor</span><span class="p">,</span> <span class="nx">HttpHandler</span><span class="p">,</span> <span class="nx">HttpRequest</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/common/http'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">AuthService</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'./auth/auth.service'</span><span class="p">;</span>

<span class="p">@</span><span class="nd">Injectable</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">MyHttpInterceptor</span> <span class="kr">implements</span> <span class="nx">HttpInterceptor</span> <span class="p">{</span>
<span class="kd">constructor</span><span class="p">(</span><span class="kr">private</span> <span class="nx">authService</span><span class="p">:</span> <span class="nx">AuthService</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>

<span class="nx">intercept</span><span class="p">(</span><span class="nx">req</span><span class="p">:</span> <span class="nx">HttpRequest</span><span class="o">&lt;</span><span class="nx">any</span><span class="o">&gt;</span><span class="p">,</span> <span class="nx">next</span><span class="p">:</span> <span class="nx">HttpHandler</span><span class="p">):</span> <span class="nx">Observable</span><span class="o">&lt;</span><span class="nx">HttpEvent</span><span class="o">&lt;</span><span class="nx">any</span><span class="o">&gt;&gt;</span> <span class="p">{</span>

  <span class="c1">// Clone the request to add the new header.</span>
  <span class="kd">const</span> <span class="nx">authReq</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">clone</span><span class="p">({</span> <span class="na">headers</span><span class="p">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="kd">set</span><span class="p">(</span><span class="s1">'Authorization'</span><span class="p">,</span> <span class="s1">'Bearer '</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">authService</span><span class="p">.</span><span class="nx">getToken</span><span class="p">())});</span>

  <span class="c1">// send the newly created request</span>
  <span class="k">return</span> <span class="nx">next</span><span class="p">.</span><span class="nx">handle</span><span class="p">(</span><span class="nx">authReq</span><span class="p">).</span><span class="nx">pipe</span><span class="p">(</span>
      <span class="nx">catchError</span><span class="p">((</span><span class="nx">error</span><span class="p">,</span> <span class="nx">caught</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="c1">// intercept the response error and displace it to the console</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Error Occurred'</span><span class="p">);</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
      <span class="c1">// return the error to the method that called it</span>
      <span class="k">return</span> <span class="nx">observableThrowError</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
  <span class="p">}))</span> <span class="k">as</span> <span class="nx">any</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
<p>Once you add the class MyHttpInterceptor you need to add it to your providers in app module and it will send the header Authorization with Bearer and an access token on each request!</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">providers</span><span class="p">:</span> <span class="p">[</span><span class="nx">AuthService</span><span class="p">,</span>
<span class="p">{</span>
<span class="na">provide</span><span class="p">:</span> <span class="nx">HTTP_INTERCEPTORS</span><span class="p">,</span>
<span class="na">useClass</span><span class="p">:</span> <span class="nx">MyHttpInterceptor</span><span class="p">,</span>
<span class="na">multi</span><span class="p">:</span> <span class="kc">true</span>
<span class="p">}],</span>
</code></pre></div></div>

</div>

  </div>
  <div class="col"></div>
</div>
<footer>
  <p><img src="/images/octocat-icon.png"><a href="https://pages.github.com">GitHub Pages</a> Brent Gaither  brent[dot]w[dot]gaither[at]gmail[dot]com</p>

</footer>

</body>
